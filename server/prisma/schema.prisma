// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  player
  coach
  judge
  admin
  school_admin
  sponsor
}

enum TierLevel {
  beginner
  amateur
  regular
  professional
  legendary
  national
}

enum StudentRole {
  Developer
  Designer
  Strategist
}

enum MatchStatus {
  scheduled
  in_progress
  completed
  cancelled
}

model Profile {
  id                String      @id @default(uuid())
  email             String      @unique @db.VarChar(255)
  password          String?     @db.VarChar(255) // Hashed password
  fullName          String      @map("full_name") @db.VarChar(255)
  role              UserRole    @default(player)
  avatarUrl         String?     @map("avatar_url") @db.VarChar(500)
  // Password reset fields
  resetToken        String?     @map("reset_token") @db.VarChar(255)
  resetTokenExpiry  DateTime?   @map("reset_token_expiry")
  // Student-specific fields
  studentRole       StudentRole? @map("student_role")
  age               Int?
  grade             Int?
  xp                Int         @default(0)
  // School relationships
  schoolId          String?     @map("school_id") // For school_admin role
  studentSchoolId  String?     @map("student_school_id") // For students - direct link to school
  createdAt         DateTime    @default(now()) @map("created_at")
  updatedAt         DateTime    @updatedAt @map("updated_at")

  // Relations
  teamsAsCaptain Team[]          @relation("TeamCaptain")
  teamMembers    TeamMember[]
  coachProfile    Coach?
  school          School?         @relation("SchoolAdmin", fields: [schoolId], references: [id])
  studentSchool   School?         @relation("StudentSchool", fields: [studentSchoolId], references: [id])
  notifications  Notification[]
  sentMessages   Message[]       @relation("MessageSender")
  receivedMessages Message[]      @relation("MessageReceiver")
  academyProgress AcademyProgress[]
  challengeSubmissions ChallengeSubmission[]
  assignedMatches MatchJudge[] @relation("JudgeAssignments")
  judgeScores    JudgeScore[] @relation("JudgeScorers")
  playerScores   PlayerScore[] @relation("PlayerScorers")
  feedbackGiven  MatchFeedback[] @relation("FeedbackGivers")
  lineupPlayers  Lineup[] @relation("LineupPlayers")
  scoredAsPlayer PlayerScore[] @relation("ScoredPlayers")
  feedbackReceived MatchFeedback[] @relation("FeedbackReceivers")
  teamFeedbackAuthored TeamFeedback[] @relation("TeamFeedbackAuthor")

  @@map("profiles")
}

model School {
  id        String     @id @default(uuid())
  name      String     @db.VarChar(255)
  location  String?    @db.VarChar(255)
  tier      TierLevel  @default(beginner)
  motto     String?    @db.VarChar(500)
  sponsor   String?    @db.VarChar(255)
  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime   @updatedAt @map("updated_at")

  // School Profile Settings
  logoUrl         String?    @map("logo_url") @db.VarChar(500)
  bannerUrl       String?    @map("banner_url") @db.VarChar(500)
  address         String?    @db.Text
  contactEmail    String?    @map("contact_email") @db.VarChar(255)
  contactPhone    String?    @map("contact_phone") @db.VarChar(50)
  socialMedia     String?    @map("social_media") @db.Text // JSON string for social links
  colorTheme      String?    @map("color_theme") @db.VarChar(50) // Primary color hex

  // Customization Settings
  anthemUrl       String?    @map("anthem_url") @db.VarChar(500)
  description     String?    @db.Text
  achievements    String?    @db.Text // JSON string for achievements/trophies

  // Relations
  teams  Team[]
  coaches Coach[]
  arenas Arena[]
  arenaApplications ArenaApplication[]
  schoolAdmins Profile[] @relation("SchoolAdmin")
  students Profile[] @relation("StudentSchool") // Students directly linked to school
  sponsorships SchoolSponsorship[]
  finances SchoolFinance[]
  notifications SchoolNotification[]

  @@map("schools")
}

model Team {
  id        String     @id @default(uuid())
  name      String     @db.VarChar(255)
  schoolId  String     @map("school_id")
  tier      TierLevel  @default(beginner)
  captainId String?    @map("captain_id")
  coachId   String?    @map("coach_id")
  logoUrl   String?    @map("logo_url") @db.VarChar(500)
  points    Int        @default(0)
  wins      Int        @default(0)
  draws     Int        @default(0)
  losses    Int        @default(0)
  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime   @updatedAt @map("updated_at")

  // Team Configuration Settings
  homeArena      String?    @map("home_arena") @db.VarChar(255)
  teamColors     String?    @map("team_colors") @db.VarChar(100) // JSON string for colors
  category       String?    @db.VarChar(50) // Junior / Senior
  coachCanManageLineups Boolean @default(true) @map("coach_can_manage_lineups")
  coachCanEditInfo Boolean @default(true) @map("coach_can_edit_info")
  coachCanUploadSubmissions Boolean @default(true) @map("coach_can_upload_submissions")
  coachCanViewAnalytics Boolean @default(true) @map("coach_can_view_analytics")
  coachCanManageFinances Boolean @default(false) @map("coach_can_manage_finances")

  // Relations
  school        School       @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  captain       Profile?     @relation("TeamCaptain", fields: [captainId], references: [id])
  coach         Coach?       @relation(fields: [coachId], references: [id], onDelete: SetNull)
  members       TeamMember[]
  homeMatches   Match[]      @relation("HomeTeam")
  awayMatches   Match[]      @relation("AwayTeam")
  winsAsWinner  Match[]      @relation("MatchWinner")
  challengeSubmissions ChallengeSubmission[]
  lineups       Lineup[]
  autoScores    AutoScore[]
  judgeScores   JudgeScore[]
  feedback      MatchFeedback[]
  teamFeedback  TeamFeedback[]
  finances      SchoolFinance[]

  @@map("teams")
}

model TeamMember {
  id       String   @id @default(uuid())
  teamId   String   @map("team_id")
  playerId String   @map("player_id")
  joinedAt DateTime @default(now()) @map("joined_at")

  // Relations
  team   Team    @relation(fields: [teamId], references: [id], onDelete: Cascade)
  player Profile @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@unique([teamId, playerId])
  @@map("team_members")
}

model Match {
  id          String      @id @default(uuid())
  homeTeamId  String      @map("home_team_id")
  awayTeamId  String      @map("away_team_id")
  arenaId     String?     @map("arena_id")
  scheduledAt DateTime    @map("scheduled_at")
  status      MatchStatus @default(scheduled)
  homeScore   Int?        @default(0) @map("home_score")
  awayScore   Int?        @default(0) @map("away_score")
  winnerId    String?     @map("winner_id")
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  // Relations
  homeTeam Team  @relation("HomeTeam", fields: [homeTeamId], references: [id])
  awayTeam Team  @relation("AwayTeam", fields: [awayTeamId], references: [id])
  winner   Team? @relation("MatchWinner", fields: [winnerId], references: [id])
  arena    Arena? @relation("ArenaMatch", fields: [arenaId], references: [id])
  judges   MatchJudge[]
  lineups  Lineup[]
  autoScores AutoScore[]
  judgeScores JudgeScore[]
  playerScores PlayerScore[]
  feedback MatchFeedback[]
  timer    MatchTimer?

  @@map("matches")
}

model Coach {
  id        String   @id @default(uuid())
  profileId String   @unique @map("profile_id")
  schoolId  String   @map("school_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  profile Profile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  school  School  @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  teams   Team[]
  // Students managed by this coach (through school relationship)
  // Access via: school -> teams -> members -> player

  @@map("coaches")
}

model Challenge {
  id          String    @id @default(uuid())
  title       String    @db.VarChar(255)
  description String    @db.Text
  difficulty  TierLevel
  points      Int       @default(100)
  releaseDate DateTime  @default(now()) @map("release_date")
  deadline    DateTime? @map("deadline")
  createdAt   DateTime  @default(now()) @map("created_at")

  // Relations
  submissions ChallengeSubmission[]

  @@map("challenges")
}

model Notification {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  title     String   @db.VarChar(255)
  message   String   @db.Text
  type      String   @db.VarChar(50) // match, challenge, award, message, etc.
  read      Boolean  @default(false)
  link      String?  @db.VarChar(500)
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user Profile @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model Message {
  id        String   @id @default(uuid())
  senderId  String   @map("sender_id")
  receiverId String  @map("receiver_id")
  subject   String?  @db.VarChar(255)
  content   String   @db.Text
  read      Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  sender   Profile @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  receiver Profile @relation("MessageReceiver", fields: [receiverId], references: [id], onDelete: Cascade)

  @@map("messages")
}

model AcademyProgress {
  id          String   @id @default(uuid())
  playerId    String   @map("player_id")
  courseName  String   @db.VarChar(255)
  courseTier  TierLevel @map("course_tier")
  progress    Int      @default(0) // 0-100
  completed   Boolean  @default(false)
  enrolledAt  DateTime @default(now()) @map("enrolled_at")
  completedAt DateTime? @map("completed_at")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  player Profile @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@unique([playerId, courseName])
  @@map("academy_progress")
}

model ChallengeSubmission {
  id          String    @id @default(uuid())
  challengeId String   @map("challenge_id")
  playerId     String   @map("player_id")
  teamId      String?  @map("team_id")
  submissionUrl String? @map("submission_url") @db.VarChar(500)
  status      String   @default("pending") @db.VarChar(50) // pending, reviewed, approved, rejected
  score       Int?     @default(0)
  feedback    String?  @db.Text
  submittedAt DateTime  @default(now()) @map("submitted_at")
  reviewedAt  DateTime? @map("reviewed_at")

  // Relations
  challenge Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  player    Profile   @relation(fields: [playerId], references: [id], onDelete: Cascade)
  team      Team?     @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@map("challenge_submissions")
}

model Arena {
  id          String   @id @default(uuid())
  schoolId    String   @map("school_id")
  name        String   @db.VarChar(255)
  capacity    Int      @default(50)
  facilities  String?  @db.Text
  tier        TierLevel @default(beginner)
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  school      School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  applications ArenaApplication[]
  matches     Match[]  @relation("ArenaMatch")

  @@map("arenas")
}

model ArenaApplication {
  id          String   @id @default(uuid())
  arenaId     String   @map("arena_id")
  schoolId    String   @map("school_id")
  status      String   @default("pending") @db.VarChar(50) // pending, approved, rejected
  message     String?  @db.Text
  appliedAt   DateTime @default(now()) @map("applied_at")
  reviewedAt  DateTime? @map("reviewed_at")

  // Relations
  arena  Arena  @relation(fields: [arenaId], references: [id], onDelete: Cascade)
  school School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@map("arena_applications")
}

// Judge System Models

enum JudgeStatus {
  pending
  accepted
  declined
}

enum LineupStatus {
  pending
  submitted
  approved
}

model MatchJudge {
  id        String      @id @default(uuid())
  matchId   String      @map("match_id")
  judgeId   String      @map("judge_id")
  status    JudgeStatus @default(pending)
  isMain    Boolean     @default(false) @map("is_main")
  assignedAt DateTime   @default(now()) @map("assigned_at")
  respondedAt DateTime? @map("responded_at")
  createdAt DateTime    @default(now()) @map("created_at")
  updatedAt DateTime    @updatedAt @map("updated_at")

  // Relations
  match Match  @relation(fields: [matchId], references: [id], onDelete: Cascade)
  judge Profile @relation("JudgeAssignments", fields: [judgeId], references: [id], onDelete: Cascade)

  @@unique([matchId, judgeId])
  @@map("match_judges")
}

model Lineup {
  id          String       @id @default(uuid())
  matchId     String       @map("match_id")
  teamId      String       @map("team_id")
  playerId    String       @map("player_id")
  position    String?      @db.VarChar(50)
  role        StudentRole
  isCaptain   Boolean      @default(false) @map("is_captain")
  isSubstitute Boolean     @default(false) @map("is_substitute")
  status      LineupStatus @default(pending)
  submittedAt DateTime?    @map("submitted_at")
  approvedAt  DateTime?    @map("approved_at")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  // Relations
  match Match  @relation(fields: [matchId], references: [id], onDelete: Cascade)
  team  Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)
  player Profile @relation("LineupPlayers", fields: [playerId], references: [id], onDelete: Cascade)

  @@unique([matchId, teamId, playerId])
  @@map("lineups")
}

model AutoScore {
  id              String   @id @default(uuid())
  matchId         String   @map("match_id")
  teamId          String   @map("team_id")
  functionality   Int      @default(0) // 0-100
  innovation      Int      @default(0) // 0-100
  plagiarismFlag  Boolean  @default(false) @map("plagiarism_flag")
  aiGeneratedFlag Boolean  @default(false) @map("ai_generated_flag")
  suggestions     String?  @db.Text
  evaluatedAt     DateTime @default(now()) @map("evaluated_at")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  match Match @relation(fields: [matchId], references: [id], onDelete: Cascade)
  team  Team  @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([matchId, teamId])
  @@map("auto_scores")
}

model JudgeScore {
  id                String   @id @default(uuid())
  matchId           String   @map("match_id")
  judgeId           String   @map("judge_id")
  teamId            String   @map("team_id")
  codeFunctionality Int      @default(0) @map("code_functionality") // 0-10
  innovation        Int      @default(0) // 0-10
  presentation      Int      @default(0) // 0-10
  problemRelevance  Int      @default(0) @map("problem_relevance") // 0-10
  feasibility       Int      @default(0) // 0-10
  collaboration     Int      @default(0) // 0-10
  comments          String?  @db.Text
  isLocked          Boolean  @default(false) @map("is_locked")
  submittedAt       DateTime? @map("submitted_at")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  match Match  @relation(fields: [matchId], references: [id], onDelete: Cascade)
  judge Profile @relation("JudgeScorers", fields: [judgeId], references: [id], onDelete: Cascade)
  team  Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([matchId, judgeId, teamId])
  @@map("judge_scores")
}

model PlayerScore {
  id                String   @id @default(uuid())
  matchId           String   @map("match_id")
  judgeId           String   @map("judge_id")
  playerId          String   @map("player_id")
  rolePerformance   Int      @default(0) @map("role_performance") // 0-10
  initiative        Int      @default(0) // 0-10
  technicalMastery  Int      @default(0) @map("technical_mastery") // 0-10
  creativity        Int      @default(0) // 0-10
  collaboration     Int      @default(0) // 0-10
  notes             String?  @db.Text
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  match Match  @relation(fields: [matchId], references: [id], onDelete: Cascade)
  judge Profile @relation("PlayerScorers", fields: [judgeId], references: [id], onDelete: Cascade)
  player Profile @relation("ScoredPlayers", fields: [playerId], references: [id], onDelete: Cascade)

  @@unique([matchId, judgeId, playerId])
  @@map("player_scores")
}

model MatchFeedback {
  id          String   @id @default(uuid())
  matchId     String   @map("match_id")
  judgeId     String   @map("judge_id")
  teamId      String?  @map("team_id")
  playerId    String?  @map("player_id")
  message     String   @db.Text
  isPublic    Boolean  @default(false) @map("is_public")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  match Match  @relation(fields: [matchId], references: [id], onDelete: Cascade)
  judge Profile @relation("FeedbackGivers", fields: [judgeId], references: [id], onDelete: Cascade)
  team  Team?  @relation(fields: [teamId], references: [id], onDelete: Cascade)
  player Profile? @relation("FeedbackReceivers", fields: [playerId], references: [id], onDelete: Cascade)

  @@map("match_feedback")
}

model MatchTimer {
  id              String   @id @default(uuid())
  matchId         String   @unique @map("match_id")
  startTime       DateTime? @map("start_time")
  pausedAt        DateTime? @map("paused_at")
  elapsedSeconds  Int      @default(0) @map("elapsed_seconds")
  isRunning       Boolean  @default(false) @map("is_running")
  duration        Int      @default(3600) // Match duration in seconds (default 60 mins)
  halfDuration    Int      @default(1800) // Half duration in seconds (default 30 mins, configurable 45/60)
  currentHalf     Int      @default(1) @map("current_half") // 1 or 2
  halftimeStatus  String?  @db.VarChar(50) @map("halftime_status") // null, "first_half", "halftime", "second_half"
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  match Match @relation(fields: [matchId], references: [id], onDelete: Cascade)

  @@map("match_timers")
}

model TeamFeedback {
  id        String   @id @default(uuid())
  teamId    String   @map("team_id")
  authorId  String   @map("author_id")
  message   String   @db.Text
  isPublic  Boolean  @default(true) @map("is_public")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  team   Team    @relation(fields: [teamId], references: [id], onDelete: Cascade)
  author Profile @relation("TeamFeedbackAuthor", fields: [authorId], references: [id], onDelete: Cascade)

  @@map("team_feedback")
}

model SchoolSponsorship {
  id              String   @id @default(uuid())
  schoolId        String   @map("school_id")
  sponsorName     String   @map("sponsor_name") @db.VarChar(255)
  sponsorType     String   @map("sponsor_type") @db.VarChar(50) // league_wide, direct_offer
  status          String   @default("pending") @db.VarChar(50) // pending, approved, rejected, active
  proposalUrl     String?  @map("proposal_url") @db.VarChar(500)
  offerDetails    String?  @map("offer_details") @db.Text
  assets          String?  @db.Text // JSON string for banners, ads, etc.
  appliedAt       DateTime @default(now()) @map("applied_at")
  approvedAt      DateTime? @map("approved_at")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  school School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@map("school_sponsorships")
}

model SchoolFinance {
  id              String   @id @default(uuid())
  schoolId        String   @map("school_id")
  type            String   @db.VarChar(50) // registration_fee, sponsorship_revenue, expense
  amount          Decimal  @db.Decimal(10, 2)
  description     String?  @db.Text
  status          String   @default("pending") @db.VarChar(50) // pending, paid, due, overdue
  dueDate         DateTime? @map("due_date")
  paidAt          DateTime? @map("paid_at")
  invoiceUrl      String?  @map("invoice_url") @db.VarChar(500)
  receiptUrl      String?  @map("receipt_url") @db.VarChar(500)
  teamId          String?  @map("team_id") // For team-specific expenses
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  school School @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  team   Team?  @relation(fields: [teamId], references: [id], onDelete: SetNull)

  @@map("school_finances")
}

model SchoolNotification {
  id              String   @id @default(uuid())
  schoolId        String   @map("school_id")
  notificationType String  @map("notification_type") @db.VarChar(50) // match_deadline, submission_deadline, sponsorship, arena, league_announcement, coach_change
  channel         String   @default("email") @db.VarChar(50) // email, in_app, sms
  enabled         Boolean  @default(true)
  urgencyLevel    String?  @map("urgency_level") @db.VarChar(20) // low, medium, high, critical
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  school School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@unique([schoolId, notificationType])
  @@map("school_notifications")
}

